<!DOCTYPE html>
<meta charset="utf-8">
<style>
  body { font-family: sans-serif; }
  #map { border: 1px solid #ccc; }
  .tooltip {
    position: absolute;
    pointer-events: none;
    background: rgba(255,255,255,0.9);
    padding: 4px 8px;
    border: 1px solid #999;
    font-size: 12px;
  }
</style>

<select id="metric-select">
  <option value="metric_q">Q</option>
  <option value="metric_r">R</option>
  <option value="metric_s">S</option>
  <option value="metric_t">T</option>
  <option value="metric_u">U</option>
  <option value="metric_v">V</option>
  <option value="metric_w">W</option>
  <option value="metric_x">X</option>
  <option value="metric_y">Y</option>
</select>

<svg id="map" width="900" height="600"></svg>
<div id="tooltip" class="tooltip" style="display:none;"></div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://d3js.org/topojson.v3.min.js"></script>
<script>
(async function() {
  const topo = await fetch('division_map.topo.json').then(r => r.json());
  const divisions = topojson.feature(topo, topo.objects.division_map);

  const svg = d3.select('#map'),
        width = +svg.attr('width'),
        height = +svg.attr('height');

  const projection = d3.geoMercator().fitSize([width, height], divisions);
  const path = d3.geoPath().projection(projection);

  const tooltip = d3.select('#tooltip');

  let currentMetric = document.getElementById('metric-select').value;

  function updateMap() {
    const maxVal = d3.max(divisions.features, d => d.properties[currentMetric] || 0);
    const color = d3.scaleSequential(d3.interpolateBlues).domain([0, maxVal]);

    svg.selectAll('path')
      .data(divisions.features)
      .join('path')
        .attr('d', path)
        .attr('fill', d => color(d.properties[currentMetric] || 0))
        .attr('stroke', '#333')
        .attr('stroke-width', 0.5)
        .on('mousemove', function(event, d) {
          const props = d.properties;
          tooltip.style('display', 'block')
            .style('left', (event.pageX + 10) + 'px')
            .style('top', (event.pageY + 10) + 'px')
            .html(
              `<strong>Division: ${props.division_id}</strong><br>`+
               `Reported: ${props.reported ? 'Yes' : 'No'}<br>`+
               `${currentMetric}: ${props[currentMetric]}<br>`+
               `Mayor (D): ${props.mayor_dem}<br>`+
               `Mayor (R): ${props.mayor_rep}<br>`+
               `Council total: ${props.council_total}`
            );
        })
        .on('mouseout', () => tooltip.style('display', 'none'));
  }

  updateMap();

  document.getElementById('metric-select')
    .addEventListener('change', function() {
      currentMetric = this.value;
      updateMap();
    });
})();
</script>
